---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import MaturityBadge from '../../components/MaturityBadge.astro';
import TopicVisual from '../../components/TopicVisual.svelte';

// Get all non-draft garden notes
const allNotes = await getCollection('garden', ({ data }) => !data.draft);

// Sort by updated date (or created if not updated)
const sortedNotes = allNotes.sort((a, b) => {
  const dateA = a.data.updated || a.data.created;
  const dateB = b.data.updated || b.data.created;
  return dateB.getTime() - dateA.getTime();
});

// Group by topic
const topics = {
  systems: { label: 'Systems Thinking', icon: '◎', notes: [] as typeof allNotes },
  hospitality: { label: 'Restaurant & Hospitality', icon: '◇', notes: [] as typeof allNotes },
  horticulture: { label: 'Growing Things', icon: '❋', notes: [] as typeof allNotes },
  ai: { label: 'AI & Technology', icon: '⬡', notes: [] as typeof allNotes },
  play: { label: 'Play & Analysis', icon: '◈', notes: [] as typeof allNotes },
  meta: { label: 'Meta', icon: '○', notes: [] as typeof allNotes },
};

sortedNotes.forEach(note => {
  topics[note.data.topic].notes.push(note);
});

// Get unique tags for filtering
const allTags = [...new Set(sortedNotes.flatMap(note => note.data.tags))].sort();
---

<BaseLayout
  title="Garden"
  description="A digital garden of interconnected ideas on systems thinking, hospitality, horticulture, and AI."
>
  <!-- Header -->
  <section class="section pb-12">
    <div class="container-wide">
      <div class="max-w-3xl">
        <p class="text-accent-amber font-sans text-small uppercase tracking-widest mb-4">
          Digital Garden
        </p>
        <h1 class="text-h1 font-serif text-text-primary mb-6">
          Ideas in Cultivation
        </h1>
        <p class="text-body text-text-secondary">
          This is a collection of interconnected notes at various stages of development.
          Some are <span class="maturity-seedling">seedlings</span> — just planted ideas.
          Others are <span class="maturity-budding">budding</span> — growing and developing.
          A few are <span class="maturity-evergreen">evergreen</span> — mature and well-tended.
        </p>
      </div>
    </div>
  </section>

  <!-- Filter Tags -->
  <section class="pb-12">
    <div class="container-wide">
      <div class="flex flex-wrap gap-2">
        <span class="text-text-tertiary text-small mr-2 self-center">Filter:</span>
        {allTags.slice(0, 12).map(tag => (
          <button
            class="tag-filter px-3 py-1 rounded-full text-small border border-garden-border text-text-secondary hover:border-accent-amber hover:text-accent-amber transition-colors"
            data-tag={tag}
          >
            {tag}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Notes Grid by Topic -->
  <section class="section pt-0">
    <div class="container-wide">
      {Object.entries(topics).map(([topicKey, topic]) => topic.notes.length > 0 && (
        <div class="mb-16 last:mb-0">
          <div class="flex items-center gap-4 mb-6 pb-3 border-b border-garden-border/30">
            <div class="hidden sm:block flex-shrink-0">
              <TopicVisual client:visible topic={topicKey as any} size={60} />
            </div>
            <div class="flex items-center gap-3 flex-1">
              <span class="text-xl text-accent-amber sm:hidden">{topic.icon}</span>
              <h2 class="text-h3 font-serif text-text-primary">{topic.label}</h2>
              <span class="text-text-tertiary text-small">({topic.notes.length})</span>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {topic.notes.map(note => (
              <a
                href={`/garden/${note.slug}`}
                class="card-hover group"
                data-tags={note.data.tags.join(',')}
              >
                <div class="flex items-center gap-2 mb-3">
                  <MaturityBadge maturity={note.data.maturity} showLabel={false} />
                  <span class="text-text-tertiary text-small">
                    {(note.data.updated || note.data.created).toLocaleDateString('en-US', {
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric'
                    })}
                  </span>
                </div>

                <h3 class="text-body font-serif text-text-primary group-hover:text-accent-amber transition-colors mb-2">
                  {note.data.title}
                </h3>

                {note.data.description && (
                  <p class="text-text-secondary text-small line-clamp-2">
                    {note.data.description}
                  </p>
                )}

                {note.data.tags.length > 0 && (
                  <div class="flex flex-wrap gap-1 mt-3">
                    {note.data.tags.slice(0, 3).map(tag => (
                      <span class="text-xs text-text-tertiary bg-garden-black px-2 py-0.5 rounded">
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
              </a>
            ))}
          </div>
        </div>
      ))}
    </div>
  </section>

  <!-- View Graph CTA -->
  <section class="section pt-0">
    <div class="container-wide">
      <div class="card bg-garden-black/30 border-garden-border/30 p-8 text-center">
        <p class="text-text-secondary mb-4">
          Want to see how these ideas connect?
        </p>
        <a href="/graph" class="btn-ghost">
          Explore the Knowledge Graph →
        </a>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Simple tag filtering
  const filterButtons = document.querySelectorAll('.tag-filter');
  const noteCards = document.querySelectorAll('[data-tags]');
  let activeTag: string | null = null;

  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tag = button.getAttribute('data-tag');

      // Toggle active state
      if (activeTag === tag) {
        activeTag = null;
        filterButtons.forEach(btn => btn.classList.remove('border-accent-amber', 'text-accent-amber'));
      } else {
        activeTag = tag;
        filterButtons.forEach(btn => {
          if (btn.getAttribute('data-tag') === tag) {
            btn.classList.add('border-accent-amber', 'text-accent-amber');
          } else {
            btn.classList.remove('border-accent-amber', 'text-accent-amber');
          }
        });
      }

      // Filter cards
      noteCards.forEach(card => {
        const cardTags = card.getAttribute('data-tags')?.split(',') || [];
        if (!activeTag || cardTags.includes(activeTag)) {
          (card as HTMLElement).style.display = '';
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });
    });
  });
</script>
